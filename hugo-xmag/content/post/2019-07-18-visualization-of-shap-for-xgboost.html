<link href="2019-07-18-visualization-of-shap-for-xgboost_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="2019-07-18-visualization-of-shap-for-xgboost_files/pagedtable-1.1/js/pagedtable.js"></script>

<div id="TOC">
<ul>
<li><a href="#shap-values-local-explanation-to-global-understanding">SHAP values: local explanation to global understanding</a><ul>
<li><a href="#local-explanation">Local Explanation</a></li>
</ul></li>
<li><a href="#shap-plots">SHAP plots</a><ul>
<li><a href="#shap-force-plot">SHAP force plot</a></li>
<li><a href="#summary-plot">Summary plot</a></li>
<li><a href="#dependence-plot">Dependence plot</a></li>
<li><a href="#interaction-values">Interaction values</a></li>
</ul></li>
</ul>
</div>

<div id="shap-values-local-explanation-to-global-understanding" class="section level1">
<h1>SHAP values: local explanation to global understanding</h1>
<p>Tree-based machine learning models (random forest, gradient boosting, XGBoost) are the most popular non-linear models today. SHAP (SHapley Additive exPlnation) values is claimed to be the most advanced method to interpret results from tree-based models. It was based on Shaply values from game theory.</p>
<p>Main papers for reference:<br />
1. 2017 <a href="https://arxiv.org/abs/1705.07874">A Unified Approach to Interpreting Model Predictions</a><br />
2. 2019 <a href="https://arxiv.org/abs/1802.03888">Consistent Individualized Feature Attribution for Tree
Ensembles</a><br />
3. 2019 <a href="https://arxiv.org/abs/1905.04610">Explainable AI for Trees: From Local Explanations to Global Understanding</a><br />
The <a href="https://github.com/slundberg/shap">github page</a> that explains these visualization functions developed by <em>Scott Lundberg</em> in Python. Here we do them in R. In r package <em>xgboost</em> there is only one simple function <em>xgb.plot.shap</em> that can make the dependence plot.</p>
<p>According the paper 3, SHAP’s main advantages are 1. local explanation; and 2. consistency in global model structure.</p>
<div id="local-explanation" class="section level2">
<h2>Local Explanation</h2>
<pre><code>## [1]  train-rmse:0.000000</code></pre>
<p>Shapley values are caculated across the entire dataset. The SHAP values dataset has the same dimention (8441,9) as the dataset of the independent variables (8441,9) fit into the xgboost model.</p>
<p>The sum of each row’s SHAP values (plus the bias, which is like an intercept) is the predicted model output. As in the following table of SHAP values, <code>rowSum</code> equals the <code>predict(xgb_mod)</code>. I.e., the explanation’s attribution values sum up to the model output.</p>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["dayint"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Column_WV"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["AOT_Uncertainty"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["elev"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["aod"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["RelAZ"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["DevAll_P1km"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["dist_water_km"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["forestProp_1km"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["BIAS"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["rowSum"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["pred_mod"],"name":[12],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.0070386184","2":"-0.0376731306","3":"0.020876542","4":"-0.0008492162","5":"-0.0855836198","6":"0.0501965582","7":"-0.0101708397","8":"0.0021054428","9":"0.015109403","10":"-0.05339295","11":"-0.092343","12":"-0.092344"},{"1":"0.0502972789","2":"0.0006737772","3":"0.047643159","4":"-0.0019284933","5":"0.0661649331","6":"0.0081639187","7":"-0.0348326638","8":"0.0092288889","9":"-0.055594012","10":"-0.05339295","11":"0.036424","12":"0.036424"},{"1":"0.0301350765","2":"0.0111122429","3":"0.076737627","4":"0.0000360791","5":"0.0288606882","6":"0.0288401395","7":"-0.0017635822","8":"0.0017423824","9":"0.020552069","10":"-0.05339295","11":"0.142860","12":"0.142860"},{"1":"0.0120246923","2":"-0.0250096079","3":"0.081778757","4":"-0.0018937917","5":"0.0304371752","6":"0.0076422771","7":"-0.0167255048","8":"-0.0046449052","9":"-0.047040276","10":"-0.05339295","11":"-0.016824","12":"-0.016824"},{"1":"-0.0157407764","2":"-0.0924345255","3":"0.085930690","4":"-0.0035214631","5":"-0.0777733102","6":"-0.0084131379","7":"-0.0413082764","8":"-0.0114760725","9":"-0.083593369","10":"-0.05339295","11":"-0.301723","12":"-0.301723"},{"1":"0.0288431756","2":"0.0302140135","3":"0.077200241","4":"0.0108802356","5":"0.0019875458","6":"0.0249079280","7":"0.0633503348","8":"0.0382501632","9":"0.043964285","10":"-0.05339295","11":"0.266205","12":"0.266204"},{"1":"-0.0146597708","2":"-0.0171836764","3":"-0.093078837","4":"-0.0023059989","5":"-0.1364119351","6":"-0.0128096584","7":"-0.0046013305","8":"-0.0009510429","9":"0.011633596","10":"-0.05339295","11":"-0.323762","12":"-0.323762"},{"1":"0.0082197208","2":"-0.0177737512","3":"-0.002003492","4":"-0.0026536118","5":"-0.1082028598","6":"0.0092309499","7":"-0.0407283530","8":"-0.0063071698","9":"-0.052668549","10":"-0.05339295","11":"-0.266280","12":"-0.266280"},{"1":"0.0374067314","2":"-0.0227064472","3":"-0.021024853","4":"0.0014106227","5":"-0.0699193850","6":"0.0377969034","7":"-0.0221640356","8":"-0.0043351403","9":"-0.063829392","10":"-0.05339295","11":"-0.180758","12":"-0.180758"},{"1":"0.0530323423","2":"0.0051571126","3":"-0.019763239","4":"0.0099948635","5":"-0.0316548422","6":"0.0174546875","7":"0.0395793580","8":"0.0265469998","9":"0.023349959","10":"-0.05339295","11":"0.070304","12":"0.070304"},{"1":"0.1286078244","2":"-0.0449513905","3":"-0.051652778","4":"0.0115053626","5":"-0.1611619443","6":"-0.0647909567","7":"-0.0195767097","8":"0.0027264298","9":"-0.063080497","10":"-0.05339295","11":"-0.315768","12":"-0.315768"},{"1":"0.0368599407","2":"0.0019530840","3":"0.046411455","4":"-0.0010429781","5":"0.0373795591","6":"0.0403483324","7":"-0.0097107673","8":"-0.0016309302","9":"-0.037879847","10":"-0.05339295","11":"0.059295","12":"0.059294"},{"1":"0.0407093316","2":"-0.0154464189","3":"0.082247473","4":"0.0223437864","5":"-0.0318445116","6":"0.1263694018","7":"-0.0103650903","8":"0.0002337667","9":"-0.048945572","10":"-0.05339295","11":"0.111909","12":"0.111908"},{"1":"-0.0006650486","2":"-0.0267972555","3":"0.045198224","4":"-0.0024621745","5":"0.0434100255","6":"-0.0023224519","7":"-0.0508821942","8":"0.0050378344","9":"-0.076434247","10":"-0.05339295","11":"-0.119310","12":"-0.119310"},{"1":"0.0112753548","2":"-0.0125189377","3":"0.025906065","4":"0.0038215052","5":"0.0507498421","6":"0.0031002180","7":"-0.0258035231","8":"0.0109375371","9":"-0.065163024","10":"-0.05339295","11":"-0.051088","12":"-0.051087"},{"1":"0.0060165292","2":"-0.0270394329","3":"0.050440989","4":"0.0023234193","5":"0.0018956346","6":"0.0172969382","7":"0.0019720006","8":"0.0010778861","9":"0.018539343","10":"-0.05339295","11":"0.019130","12":"0.019130"},{"1":"-0.0055780425","2":"-0.0189118162","3":"0.051178724","4":"-0.0010463087","5":"0.0208350401","6":"0.0044331905","7":"-0.0128954491","8":"-0.0053032958","9":"-0.054706898","10":"-0.05339295","11":"-0.075388","12":"-0.075387"},{"1":"0.0053667510","2":"-0.0267512184","3":"0.033038598","4":"0.0058431271","5":"0.0179259479","6":"0.0201030411","7":"0.0333142243","8":"0.0345324688","9":"0.029983733","10":"-0.05339295","11":"0.099964","12":"0.099964"},{"1":"0.0050789998","2":"-0.0488252826","3":"-0.079636239","4":"-0.0068250340","5":"-0.1036846787","6":"-0.0159041043","7":"-0.0010332209","8":"0.0023124490","9":"0.021078344","10":"-0.05339295","11":"-0.280832","12":"-0.280832"},{"1":"0.0212008040","2":"-0.0145273488","3":"0.086508632","4":"0.0036774869","5":"0.0434329547","6":"0.0134457750","7":"-0.0236330219","8":"0.0068901721","9":"-0.063768871","10":"-0.05339295","11":"0.019834","12":"0.019834"},{"1":"0.0679105818","2":"0.0234309789","3":"0.103287987","4":"0.0104304682","5":"0.0016811009","6":"0.0790388808","7":"0.0092458557","8":"0.0054588304","9":"0.035872143","10":"-0.05339295","11":"0.282964","12":"0.282962"},{"1":"0.0262732469","2":"-0.0099548120","3":"0.072413407","4":"-0.0019497246","5":"0.0372989736","6":"0.0511169136","7":"-0.0191402622","8":"-0.0045504440","9":"-0.057964951","10":"-0.05339295","11":"0.040149","12":"0.040148"},{"1":"0.0037896896","2":"-0.0310879648","3":"0.093764380","4":"0.0021518471","5":"-0.0655236766","6":"0.0742986053","7":"-0.0368019827","8":"-0.0078460807","9":"-0.076523639","10":"-0.05339295","11":"-0.097172","12":"-0.097172"},{"1":"-0.0366389342","2":"-0.0665915534","3":"-0.099436603","4":"-0.0066676433","5":"-0.2059816420","6":"-0.0709463283","7":"-0.1138710678","8":"-0.0062203952","9":"-0.128383026","10":"-0.05339295","11":"-0.788130","12":"-0.788132"},{"1":"-0.0150274560","2":"-0.0691032708","3":"-0.096304953","4":"0.0018003195","5":"-0.1915559173","6":"-0.0636936277","7":"-0.0555156805","8":"-0.0060154814","9":"-0.115430377","10":"-0.05339295","11":"-0.664239","12":"-0.664242"},{"1":"-0.0122459428","2":"-0.0418363512","3":"-0.000160332","4":"-0.0055851149","5":"-0.1387852579","6":"-0.0296574309","7":"-0.0005040228","8":"0.0034465531","9":"0.027585633","10":"-0.05339295","11":"-0.251135","12":"-0.251136"},{"1":"-0.0301162321","2":"-0.0950693712","3":"0.023058835","4":"-0.0101509606","5":"-0.1551497281","6":"-0.0702228919","7":"-0.1193055212","8":"-0.0148926675","9":"-0.118687451","10":"-0.05339295","11":"-0.643929","12":"-0.643931"},{"1":"-0.0147763742","2":"-0.0573121570","3":"-0.003144830","4":"0.0042453576","5":"-0.0746361315","6":"-0.0341275483","7":"-0.0490581952","8":"-0.0099191237","9":"-0.104224809","10":"-0.05339295","11":"-0.396347","12":"-0.396347"},{"1":"0.0060286396","2":"-0.0119070169","3":"0.072796784","4":"0.0167695023","5":"-0.0564807467","6":"0.0780864209","7":"-0.0447152890","8":"0.0068935109","9":"-0.049397357","10":"-0.05339295","11":"-0.035318","12":"-0.035318"},{"1":"-0.0217763036","2":"-0.1041396931","3":"-0.108027570","4":"-0.0035377040","5":"-0.1764514595","6":"-0.0494062155","7":"-0.0403578654","8":"-0.0103062000","9":"-0.117457844","10":"-0.05339295","11":"-0.684854","12":"-0.684854"},{"1":"0.0375434570","2":"-0.0200911649","3":"0.108874753","4":"-0.0014203984","5":"-0.1265890300","6":"-0.0382782146","7":"-0.1011948884","8":"0.0047972598","9":"-0.091082387","10":"-0.05339295","11":"-0.280834","12":"-0.280834"},{"1":"-0.0483274870","2":"-0.0846450701","3":"0.063268431","4":"0.0013454409","5":"-0.0184503756","6":"0.0331802294","7":"-0.0170994774","8":"-0.0021924416","9":"0.019097798","10":"-0.05339295","11":"-0.107216","12":"-0.107216"},{"1":"-0.0869463980","2":"-0.1544026881","3":"0.061386894","4":"-0.0099626705","5":"-0.0967196450","6":"0.0264042784","7":"-0.0430791229","8":"-0.0215250682","9":"-0.075109899","10":"-0.05339295","11":"-0.453347","12":"-0.453347"},{"1":"-0.0555138141","2":"-0.1158048138","3":"0.056838818","4":"-0.0039938292","5":"-0.1005292609","6":"-0.0259366967","7":"-0.0620180517","8":"-0.0146542853","9":"-0.105289228","10":"-0.05339295","11":"-0.480294","12":"-0.480294"},{"1":"-0.0283573791","2":"-0.1495931894","3":"-0.045039091","4":"-0.0031182203","5":"-0.0967820138","6":"0.0069462685","7":"-0.0603387803","8":"-0.0147682102","9":"-0.088594139","10":"-0.05339295","11":"-0.533038","12":"-0.533039"},{"1":"0.0123235583","2":"-0.0240224749","3":"-0.022429956","4":"-0.0038789478","5":"0.0529069789","6":"-0.0158538837","7":"-0.0435961150","8":"0.0003787010","9":"-0.061828442","10":"-0.05339295","11":"-0.159394","12":"-0.159393"},{"1":"0.0191994179","2":"-0.0078483578","3":"-0.016019268","4":"0.0033686648","5":"0.0565068237","6":"0.0007095218","7":"-0.0175163317","8":"0.0064321184","9":"-0.054732069","10":"-0.05339295","11":"-0.063292","12":"-0.063292"},{"1":"-0.0029912298","2":"-0.0107712550","3":"-0.015029308","4":"-0.0019361933","5":"0.0282663610","6":"0.0075270105","7":"-0.0070559336","8":"0.0013610731","9":"0.014283554","10":"-0.05339295","11":"-0.039739","12":"-0.039738"},{"1":"-0.0130470460","2":"-0.0253540780","3":"0.031195112","4":"-0.0037156143","5":"0.0505770594","6":"-0.0083344346","7":"-0.0282384530","8":"-0.0061589149","9":"-0.061636288","10":"-0.05339295","11":"-0.118106","12":"-0.118105"},{"1":"-0.0065149409","2":"-0.0206818786","3":"0.007261820","4":"-0.0002735764","5":"0.0405816846","6":"0.0042779674","7":"-0.0107733402","8":"-0.0062108357","9":"-0.057679087","10":"-0.05339295","11":"-0.103405","12":"-0.103405"},{"1":"0.0206129700","2":"0.0038407131","3":"-0.034552425","4":"0.0074683265","5":"-0.0117385909","6":"0.0080359569","7":"0.0353289358","8":"0.0229467656","9":"0.016597092","10":"-0.05339295","11":"0.015147","12":"0.015147"},{"1":"-0.0111367982","2":"0.0094746687","3":"0.048074111","4":"0.0043420787","5":"-0.0169541575","6":"0.0308996979","7":"-0.0003423036","8":"0.0036369434","9":"0.023126369","10":"-0.05339295","11":"0.037728","12":"0.037728"},{"1":"-0.0229784176","2":"-0.0413658209","3":"0.073008098","4":"-0.0021224171","5":"-0.0538273789","6":"0.0249127988","7":"-0.0345128067","8":"-0.0076873256","9":"-0.064541452","10":"-0.05339295","11":"-0.182508","12":"-0.182508"},{"1":"-0.0097766025","2":"-0.0215214733","3":"0.030620523","4":"-0.0009435680","5":"0.0332191437","6":"0.0383917950","7":"-0.0099576954","8":"-0.0078833802","9":"-0.051481590","10":"-0.05339295","11":"-0.052726","12":"-0.052726"},{"1":"0.0287338533","2":"-0.0646816269","3":"-0.040568642","4":"0.0071865632","5":"-0.0361688882","6":"-0.0203273445","7":"-0.0321790837","8":"0.0053117312","9":"-0.072242171","10":"-0.05339295","11":"-0.278329","12":"-0.278329"},{"1":"0.0208359417","2":"-0.0556859300","3":"0.084237009","4":"-0.0066382349","5":"-0.1751401871","6":"-0.0665479600","7":"-0.0979955569","8":"-0.0121816825","9":"-0.095237531","10":"-0.05339295","11":"-0.457747","12":"-0.457748"},{"1":"-0.0349813513","2":"-0.0434993207","3":"0.031405777","4":"-0.0009701864","5":"-0.0270224120","6":"-0.0142709268","7":"-0.0329481810","8":"-0.0101056006","9":"-0.084860586","10":"-0.05339295","11":"-0.270646","12":"-0.270646"},{"1":"0.0253356304","2":"-0.0404300466","3":"0.102306388","4":"0.0228635911","5":"-0.0511127338","6":"0.0635028258","7":"-0.0318158120","8":"0.0021144541","9":"-0.051659439","10":"-0.05339295","11":"-0.012288","12":"-0.012288"},{"1":"0.0123735107","2":"-0.0438467041","3":"0.080881566","4":"0.0013343386","5":"0.0472245254","6":"-0.0121653313","7":"-0.0426754281","8":"0.0108945174","9":"-0.075509503","10":"-0.05339295","11":"-0.074881","12":"-0.074881"},{"1":"0.0066393167","2":"-0.0754821301","3":"0.071681596","4":"0.0104968287","5":"0.0428760946","6":"-0.0192172416","7":"-0.0411594287","8":"0.0070832996","9":"-0.074824564","10":"-0.05339295","11":"-0.125299","12":"-0.125299"},{"1":"0.0030576261","2":"-0.1045814902","3":"-0.070504829","4":"0.0028457828","5":"-0.1562401652","6":"-0.0556194857","7":"-0.0414047986","8":"-0.0015137428","9":"-0.102509849","10":"-0.05339295","11":"-0.579864","12":"-0.579865"},{"1":"-0.0440939032","2":"-0.1058658361","3":"0.065078281","4":"0.0036520304","5":"-0.0903157070","6":"-0.0252260435","7":"-0.0590787567","8":"-0.0129094040","9":"-0.095990486","10":"-0.05339295","11":"-0.418143","12":"-0.418143"},{"1":"-0.0202203896","2":"-0.0440484919","3":"0.111300118","4":"0.0052469554","5":"-0.0907028168","6":"-0.0293907784","7":"-0.0353424288","8":"-0.0065304129","9":"-0.075699739","10":"-0.05339295","11":"-0.238781","12":"-0.238780"},{"1":"-0.0194860436","2":"-0.0737900808","3":"0.063216418","4":"0.0002351932","5":"-0.0486606471","6":"0.0471654125","7":"-0.0444520600","8":"-0.0091225384","9":"-0.061327051","10":"-0.05339295","11":"-0.199614","12":"-0.199615"},{"1":"-0.0129763447","2":"-0.0379199572","3":"-0.032148723","4":"-0.0045247390","5":"-0.0111707654","6":"-0.0258619152","7":"-0.0693472326","8":"0.0009361776","9":"-0.060436044","10":"-0.05339295","11":"-0.306842","12":"-0.306843"},{"1":"0.0258925352","2":"-0.0061702449","3":"-0.006168447","4":"0.0116857011","5":"0.0150724240","6":"-0.0079960478","7":"-0.0158737879","8":"0.0110100117","9":"-0.041264646","10":"-0.05339295","11":"-0.067205","12":"-0.067205"},{"1":"-0.0386594012","2":"-0.1038855016","3":"-0.096146695","4":"-0.0079041095","5":"-0.0985994935","6":"-0.0423673615","7":"-0.0822729841","8":"-0.0106056714","9":"-0.102069691","10":"-0.05339295","11":"-0.635904","12":"-0.635904"},{"1":"-0.0107864663","2":"-0.0848743394","3":"-0.080510221","4":"0.0026425123","5":"-0.0680617914","6":"-0.0340081267","7":"-0.0378882997","8":"-0.0036185009","9":"-0.097436413","10":"-0.05339295","11":"-0.467935","12":"-0.467935"},{"1":"-0.0230322089","2":"-0.1386180073","3":"-0.011737250","4":"-0.0127186608","5":"-0.2580401897","6":"-0.1299773753","7":"-0.1469193250","8":"-0.0205835104","9":"-0.127474591","10":"-0.05339295","11":"-0.922494","12":"-0.922497"},{"1":"-0.0137071144","2":"-0.0737830475","3":"-0.012133729","4":"0.0027839483","5":"-0.0660235435","6":"-0.0037771356","7":"-0.0280910805","8":"-0.0082941800","9":"-0.101591818","10":"-0.05339295","11":"-0.358011","12":"-0.358011"},{"1":"-0.0251676459","2":"-0.1243724898","3":"-0.224901259","4":"-0.0194975454","5":"-0.3475365043","6":"-0.0906810910","7":"0.0246498510","8":"-0.0372058377","9":"-0.024314305","10":"-0.05339295","11":"-0.922420","12":"-0.922422"},{"1":"0.0005738935","2":"-0.0213211235","3":"0.028734516","4":"0.0061621596","5":"0.0358117521","6":"0.0328549929","7":"-0.0239894725","8":"0.0083495099","9":"-0.058237959","10":"-0.05339295","11":"-0.044455","12":"-0.044454"},{"1":"-0.0122311227","2":"-0.0148669276","3":"0.050854690","4":"-0.0013413784","5":"-0.0370953269","6":"0.0146359531","7":"-0.0339519717","8":"-0.0077290260","9":"-0.058445167","10":"-0.05339295","11":"-0.153563","12":"-0.153563"},{"1":"-0.0114522967","2":"-0.0742935464","3":"0.039525524","4":"0.0185418073","5":"-0.1175960600","6":"0.0058266013","7":"-0.0554694347","8":"-0.0103338612","9":"-0.087335356","10":"-0.05339295","11":"-0.345980","12":"-0.345980"},{"1":"-0.0100996159","2":"-0.0277303569","3":"0.073261701","4":"-0.0024875035","5":"0.0463695042","6":"-0.0142980451","7":"-0.0251921639","8":"-0.0073835645","9":"-0.063496910","10":"-0.05339295","11":"-0.084450","12":"-0.084450"},{"1":"-0.0139416298","2":"-0.0299177319","3":"0.046838589","4":"0.0009605293","5":"0.0376009196","6":"-0.0173693597","7":"-0.0180115551","8":"-0.0091415560","9":"-0.067416824","10":"-0.05339295","11":"-0.123792","12":"-0.123791"},{"1":"0.0429047793","2":"0.0367218740","3":"0.056541573","4":"0.0097822389","5":"0.0002396026","6":"0.0015499663","7":"0.0669110194","8":"0.0371326804","9":"0.050684236","10":"-0.05339295","11":"0.249075","12":"0.249076"},{"1":"-0.0001641259","2":"-0.0357181355","3":"0.013995591","4":"-0.0018462493","5":"0.0312613472","6":"0.0063488181","7":"-0.0218506362","8":"-0.0056031444","9":"-0.048884522","10":"-0.05339295","11":"-0.115854","12":"-0.115854"},{"1":"-0.0195483044","2":"-0.0386528224","3":"-0.035512526","4":"-0.0028485474","5":"-0.0640117824","6":"0.0106447227","7":"-0.0415478759","8":"-0.0073790695","9":"-0.075748384","10":"-0.05339295","11":"-0.327998","12":"-0.327998"},{"1":"0.0038015461","2":"-0.0259998832","3":"0.018847894","4":"0.0014390489","5":"0.0455170274","6":"-0.0130582359","7":"-0.0256284121","8":"0.0072036418","9":"-0.059507892","10":"-0.05339295","11":"-0.100778","12":"-0.100778"},{"1":"-0.0012126934","2":"-0.0260520726","3":"0.084230974","4":"-0.0022088743","5":"0.0416053273","6":"-0.0071727070","7":"-0.0183344912","8":"-0.0045052026","9":"-0.054018524","10":"-0.05339295","11":"-0.041061","12":"-0.041061"},{"1":"0.0365064777","2":"0.0127938706","3":"0.042974077","4":"0.0053574899","5":"0.0426660068","6":"0.0070147798","7":"0.0507705845","8":"0.0321744010","9":"0.042075042","10":"-0.05339295","11":"0.218940","12":"0.218941"},{"1":"0.0064388867","2":"-0.0206611771","3":"0.006095647","4":"-0.0030103971","5":"0.0443564281","6":"0.0118581112","7":"-0.0372370295","8":"0.0041850568","9":"-0.047215395","10":"-0.05339295","11":"-0.088583","12":"-0.088583"},{"1":"0.0129830232","2":"-0.0110313846","3":"-0.004618502","4":"0.0052515082","5":"0.0456622913","6":"0.0184092056","7":"-0.0084636351","8":"0.0069100643","9":"-0.036776036","10":"-0.05339295","11":"-0.025066","12":"-0.025066"},{"1":"0.0264080074","2":"0.0159709565","3":"-0.010484320","4":"-0.0019191182","5":"0.0450891592","6":"-0.0079434747","7":"-0.0096932538","8":"-0.0010899431","9":"-0.032065846","10":"-0.05339295","11":"-0.029121","12":"-0.029121"},{"1":"-0.0123177310","2":"-0.0989183411","3":"-0.113041371","4":"-0.0001201381","5":"-0.1301172674","6":"-0.0202120841","7":"-0.0206455383","8":"-0.0092663839","9":"-0.107077241","10":"-0.05339295","11":"-0.565109","12":"-0.565111"},{"1":"0.0561001636","2":"0.0042120148","3":"-0.017112922","4":"0.0090633575","5":"0.0651164725","6":"0.0223756209","7":"0.0273629911","8":"0.0271342173","9":"0.022496684","10":"-0.05339295","11":"0.163356","12":"0.163355"},{"1":"0.0009045416","2":"-0.0280362274","3":"0.042521980","4":"0.0042169248","5":"0.0434431657","6":"-0.0057894327","7":"-0.0257581845","8":"0.0063452711","9":"-0.063124500","10":"-0.05339295","11":"-0.078669","12":"-0.078669"},{"1":"-0.0107126515","2":"-0.0168921053","3":"0.049138483","4":"-0.0022935404","5":"0.0352281667","6":"0.0289589185","7":"-0.0155016044","8":"-0.0036840662","9":"-0.039532576","10":"-0.05339295","11":"-0.028684","12":"-0.028684"},{"1":"0.0019648927","2":"-0.1385755688","3":"-0.060158610","4":"-0.0076500983","5":"0.0444800369","6":"-0.0388929062","7":"-0.0405554473","8":"-0.0088872071","9":"-0.093944028","10":"-0.05339295","11":"-0.395612","12":"-0.395611"},{"1":"-0.0134940613","2":"-0.0263008550","3":"0.033807185","4":"-0.0025398750","5":"0.0232411101","6":"0.0154267075","7":"-0.0158157628","8":"-0.0039715790","9":"-0.039829198","10":"-0.05339295","11":"-0.082869","12":"-0.082869"},{"1":"0.0259260051","2":"-0.0074626096","3":"0.111236446","4":"0.0359321795","5":"0.0379481502","6":"0.1600101590","7":"0.0219692793","8":"0.0035023110","9":"-0.006342804","10":"-0.05339295","11":"0.329326","12":"0.329325"},{"1":"0.0028012292","2":"-0.0318793170","3":"0.022466797","4":"0.0021530092","5":"-0.0092565166","6":"0.0154639585","7":"0.0292770285","8":"0.0303284805","9":"0.021649862","10":"-0.05339295","11":"0.029612","12":"0.029612"},{"1":"-0.0165464431","2":"-0.0238091052","3":"-0.030915545","4":"-0.0032878385","5":"0.0402271748","6":"-0.0024753723","7":"-0.0402281955","8":"0.0011861951","9":"-0.055682007","10":"-0.05339295","11":"-0.184924","12":"-0.184924"},{"1":"-0.0016901081","2":"-0.0167771522","3":"-0.027184444","4":"0.0028245074","5":"0.0406308211","6":"-0.0099752741","7":"-0.0092265503","8":"0.0043270462","9":"-0.047836736","10":"-0.05339295","11":"-0.118301","12":"-0.118300"},{"1":"-0.0248248279","2":"-0.0289807096","3":"-0.021892600","4":"-0.0058717756","5":"-0.0977154523","6":"-0.0529937744","7":"-0.0637890548","8":"-0.0100898910","9":"-0.088060983","10":"-0.05339295","11":"-0.447612","12":"-0.447612"},{"1":"0.0050314036","2":"-0.0314329788","3":"-0.057965696","4":"0.0042138947","5":"-0.0484374613","6":"-0.0142981401","7":"-0.0123681556","8":"-0.0054281116","9":"-0.067681104","10":"-0.05339295","11":"-0.281759","12":"-0.281760"},{"1":"0.0090303812","2":"0.0094761923","3":"0.069868475","4":"0.0061414442","5":"-0.0145019870","6":"0.0388217457","7":"0.0527905002","8":"0.0340344720","9":"0.040708095","10":"-0.05339295","11":"0.192976","12":"0.192976"},{"1":"0.0009424247","2":"-0.0455838069","3":"-0.040418964","4":"-0.0055104410","5":"0.0392999128","6":"-0.0322287604","7":"-0.0615924858","8":"-0.0020984425","9":"-0.080042146","10":"-0.05339295","11":"-0.280626","12":"-0.280626"},{"1":"0.0097704949","2":"-0.0186285116","3":"-0.033287100","4":"0.0047908449","5":"0.0364585891","6":"-0.0147783365","7":"-0.0098407138","8":"0.0077578486","9":"-0.047838114","10":"-0.05339295","11":"-0.118988","12":"-0.118987"},{"1":"-0.0149424691","2":"-0.0823700204","3":"0.008585463","4":"-0.0007400953","5":"0.0332457609","6":"-0.0246927943","7":"-0.0195789747","8":"-0.0113063660","9":"-0.078720674","10":"-0.05339295","11":"-0.243913","12":"-0.243912"},{"1":"-0.0033642950","2":"-0.0046334281","3":"-0.016520495","4":"0.0049312795","5":"-0.0661034510","6":"-0.0190629307","7":"0.0708467811","8":"0.0265306756","9":"0.026171124","10":"-0.05339295","11":"-0.034598","12":"-0.034597"},{"1":"-0.0277580749","2":"-0.1041531116","3":"-0.032141913","4":"-0.0012737260","5":"0.0364774056","6":"0.0180607494","7":"-0.0113132698","8":"-0.0093962261","9":"-0.041985370","10":"-0.05339295","11":"-0.226876","12":"-0.226876"},{"1":"-0.2194980979","2":"-0.1400961131","3":"-0.201825172","4":"-0.0129075563","5":"-0.1937686652","6":"-0.0900332332","7":"-0.0073928996","8":"-0.0008806879","9":"-0.016478529","10":"-0.05339295","11":"-0.936274","12":"-0.936275"},{"1":"-0.0121739004","2":"-0.0112388777","3":"-0.018587556","4":"-0.0029186201","5":"0.0388113633","6":"0.0123028820","7":"-0.0369642340","8":"0.0025112203","9":"-0.041234441","10":"-0.05339295","11":"-0.122885","12":"-0.122885"},{"1":"-0.0028981180","2":"0.0024857528","3":"-0.018827582","4":"0.0007800629","5":"0.0368217528","6":"0.0076336591","7":"-0.0099136177","8":"0.0044109328","9":"-0.031096440","10":"-0.05339295","11":"-0.063997","12":"-0.063996"},{"1":"-0.0022081817","2":"0.0062224893","3":"-0.025123697","4":"-0.0019992790","5":"0.0442669727","6":"-0.0079065310","7":"-0.0052918117","8":"-0.0019798630","9":"-0.037667084","10":"-0.05339295","11":"-0.085080","12":"-0.085080"},{"1":"0.0356735215","2":"-0.0134144146","3":"-0.055820871","4":"0.0094616376","5":"0.0185451936","6":"-0.0065173628","7":"0.0241756812","8":"0.0189282224","9":"0.015174774","10":"-0.05339295","11":"-0.007187","12":"-0.007186"},{"1":"-0.0003529410","2":"-0.0644298941","3":"-0.060684711","4":"-0.0083595896","5":"0.0463165939","6":"-0.0221612547","7":"-0.0574973524","8":"-0.0029084347","9":"-0.083255015","10":"-0.05339295","11":"-0.306726","12":"-0.306725"},{"1":"0.0138617111","2":"-0.0530462116","3":"-0.058469482","4":"0.0035333924","5":"0.0477599427","6":"-0.0170841832","7":"-0.0210306309","8":"0.0005843110","9":"-0.075388923","10":"-0.05339295","11":"-0.212673","12":"-0.212671"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>This offers model explanation for each observation in the dataset. And offers lots of flexibility when summarizing the whole model.</p>
<p><strong>Consistency in Feature Importance</strong><br />
(<strong>And why feature importance by Gain is inconsistent</strong>)</p>
<p>Consistency means it is legitimate to compare feature importance across different models. When we modify the model to make a feature more important, the feature importance should increase. The paper used the following example:</p>
<p><img src="/post/2019-07-18-visualization-of-shap-for-xgboost_files/SHAPsuppfig2.JPG" />
<em>paper 2, <a href="https://arxiv.org/abs/1905.04610">S. Lundberg 2019 arXiv:1905.04610</a></em></p>
<p>Use the dataset of Model A as a simple example, which feature goes <strong>first</strong> into the dataset generates <strong>opposite</strong> feature importance by Gain: whichever goes later (lower in the tree) gets more credit. Notice the results from <code>xgb.importance</code> were flipped.</p>
<table>
<thead>
<tr class="header">
<th align="right">Fever</th>
<th align="right">Cough</th>
<th align="right">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">80</td>
</tr>
</tbody>
</table>
<pre><code>## [1]  train-rmse:0.000000</code></pre>
<pre><code>## [1]  train-rmse:0.000000</code></pre>
<pre><code>##    Feature      Gain     Cover Frequency
## 1:   Cough 0.6666667 0.3333333       0.5
## 2:   Fever 0.3333333 0.6666667       0.5</code></pre>
<pre><code>##    Feature      Gain     Cover Frequency
## 1:   Fever 0.6666667 0.3333333       0.5
## 2:   Cough 0.3333333 0.6666667       0.5</code></pre>
<p>So the key message is, the order/structure of how the tree is built doesn’t matter for SHAP, but matters for Gain and Saabas. The explanation in the paper is a little bit confusing.</p>
<p>While for SHAP, the mean absolute SHAP is always the same (20 vs. 20).</p>
<table>
<thead>
<tr class="header">
<th align="right">x.Fever</th>
<th align="right">x.Cough</th>
<th align="right">y.actual</th>
<th align="right">y.pred</th>
<th align="right">SHAP.Fever</th>
<th align="right">SHAP.Cough</th>
<th align="right">BIAS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-10</td>
<td align="right">-10</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">-30</td>
<td align="right">10</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">10</td>
<td align="right">-30</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">80</td>
<td align="right">80</td>
<td align="right">30</td>
<td align="right">30</td>
<td align="right">20</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="shap-plots" class="section level1">
<h1>SHAP plots</h1>
<div id="shap-force-plot" class="section level2">
<h2>SHAP force plot</h2>
<p>The SHAP force plot basically stacks these SHAP values for each observation, and show how the final output was obtained as a sum of each predictor’s attribution.</p>
<p>How it looks like in python package:<br />
<img src="/post/2019-07-18-visualization-of-shap-for-xgboost_files/forceplotSHAP.png" /></p>
<p>R version:</p>
<pre><code>## Data has N: 8441 | zoom in length is 150 at location 5064.6</code></pre>
<p><img src="2019-07-18-visualization-of-shap-for-xgboost_files/figure-html/unnamed-chunk-5-1.png" width="768" /><img src="2019-07-18-visualization-of-shap-for-xgboost_files/figure-html/unnamed-chunk-5-2.png" width="768" /></p>
</div>
<div id="summary-plot" class="section level2">
<h2>Summary plot</h2>
<p>The summary plot shows global feature importance. The sina plots show the distribution of feature contributions to the model output (in this example, the predictions of CWV measurement error) using SHAP values of each feature for every observation. Each dot is an observation (station-day).</p>
<p>The SHAP values were generated from each fold of cross-validation. As a comparison, I also show the values from final model. Kind of similar.</p>
<p><img src="2019-07-18-visualization-of-shap-for-xgboost_files/figure-html/unnamed-chunk-6-1.png" width="960" /></p>
</div>
<div id="dependence-plot" class="section level2">
<h2>Dependence plot</h2>
<p>It plots the SHAP values against the feature values for each variable</p>
<p><img src="2019-07-18-visualization-of-shap-for-xgboost_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>We can also select another feature for coloring</p>
<p>In this example dot is a station-day observation.
(LEFT) SHAP values showing the contribution of the time trend to predictions. The color represents the MAIAC CWV for each observation (purple high, yellow low). The LOESS (locally estimated scatterplot smoothing) curve is overlaid in red.<br />
(RIGHT)</p>
<p><img src="2019-07-18-visualization-of-shap-for-xgboost_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>To compare Terra vs. Aqua
<img src="/post/2019-07-18-visualization-of-shap-for-xgboost_files/Figure_6a_2019_06_14_SHAP_interaction.png" />
<img src="/post/2019-07-18-visualization-of-shap-for-xgboost_files/Figure_6b_2019_06_14_SHAP_interaction.png" /></p>
</div>
<div id="interaction-values" class="section level2">
<h2>Interaction values</h2>
<p>SHAP interaction values separate the impact of variable into main effects and interaction effects. They add up roughly to the dependence plot.</p>
<p>Not sure how it is done.
<img src="/post/2019-07-18-visualization-of-shap-for-xgboost_files/interactionSHAPplot.JPG" /></p>
</div>
</div>
